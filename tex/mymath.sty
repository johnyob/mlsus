\usepackage{amsmath}
\usepackage{amsthm}

%% Mathpartir

\usepackage{mathpartir}

\newcommand{\mathparinit}{%
% spacing below and above mathpar blocks
\abovedisplayskip .5em
\belowdisplayskip .5em
}
\newcommand{\Rule}[1]{\hyperlink{#1}{\TirName {#1}}}
\renewcommand{\DefTirName}[1]{\hypertarget{#1}{\TirName {#1}}}

\newcommand \Rewrite[3][]
   {\inferrule*[fraction={==\Rightarrow},lab=#1]{#2}{#3}}
\newcommand \rewrite[3][]
   {\inferrule*[fraction={{}{-}{\smash\to}},lab=#1]{#2}{#3}}

\newcommand \hrewrite[4][]
   {\inferrule*[fraction={{-}{-}{\smash\to}},lab=#1]{#3 \\ #2}{#4}}

\newtheorem*{notation}{Notation}
\newtheorem{fact}{Fact}
\newtheorem{property}{Property}

\newenvironment{remark}
   {\paragraph{Remark}}
   {}

% This looks like a space hack, but it's not! The point
% is to remove a visually-ugly stacking of spacings coming
% from the figure and the math environment.
\newenvironment{mathparfig}[3][htb!]
   {\begin{figure}[#1]
       \abovedisplayskip 0em
       \belowdisplayskip 0em
       \def \LABEL{#2}%
       \def \CAPTION{#3}%
       \begin{mathpar}}
       {\end{mathpar}%
       \caption{\CAPTION}%
       \label{\LABEL}%
     \end{figure}}

\newenvironment{mathline}
   {\abovedisplayskip 0.4ex
    \belowdisplayskip 0.4ex
    \begin{mathpar}}
   {\end{mathpar}\ignorespacesafterend}

% TODO: Figure out how to reference judgments
\newenvironment{judgboxmathpar}[2]
  {\judgbox{#1}{#2}
   \abovedisplayskip 10pt
   \belowdisplayskip 10pt
   \begin{mathparpagebreakable}}
  {\end{mathparpagebreakable}\ignorespacesafterend}

%% Arrays and tabular
\usepackage{array}

\newcolumntype{L}{>{${}}l<{{}$}}
\newcolumntype{R}{>{${}}r<{{}$}}
\newcolumntype{C}{>{${}}c<{{}$}}

\newcolumntype{.}{@{}}
\newcolumntype{+}{@{\qquad}}
\newcolumntype{;}{@{\;}}
\newcolumntype{,}{@{\,}}

\newcolumntype{~}{@{\extracolsep{\fill}}}
\newcolumntype{=}{@{\extracolsep{0em}}}
\newcolumntype{Z}{~c=}

\newcommand {\emath}[1]{\ensuremath{#1}}

\newcommand {\bnf@entryset}[3][]
  {\bnf@flushentry \gdef\@bnf@entry {&&#1}
   & #2 &\bnf@in & #3\bnf@flushentry}
\newcommand {\bnf@emptyentry}[2][]
  {\bnf@flushentry \gdef\@bnf@entry {&&#1}
   & #2&&\bnf@flushentry}
\newcommand {\bnf@entry}[3][]
  {\bnf@flushentry \gdef\@bnf@entry {&&#1}
   & #2&\ifempty{#2}{}{\ifempty{#3}{}{\bnf@is}}& #3\bnf@flushentry}
\def \bnf@empty{\gdef \@bnf@entry{}}\bnf@empty
\def \bnf@in {\in}
\def \bnf@is {::=}
\def \bnf@mid {\mid}
\def \bnf@flushentry{\@bnf@entry \bnf@empty}
\def \bnf@andcr{\bnf@flushentry \\&&\bnf@mid&}
\def \bnf@nextline #1{\bnf@andcr \ifthenelse {\equal{#1}{\bnf@mid}}{}{#1}}

\newenvironment{bnfgrammar}[1][]
  {\let \entry \bnf@entry
   \let \entryset \bnf@entryset
   \let \is \bnf@is
   \let \and \bnf@mid
   \let \andcr \bnf@andcr
   \let \And \bnf@andcr
   \let \nextline \bnf@nextline
   #1\relax
   \begin{tabular*}{\linewidth}{.C~R=;;R;;LL~r.}}
 {\end{tabular*}}

\newcommand{\leftalign}[2][.L.]
   {\begin{tabular}[#1]#2\end{tabular}}

\newcommand{\Defined}{\downarrow\mathclose{}}
\newcommand{\Undefined}{\uparrow\mathclose{}}

\newenvironment{bnffig}[3][htb!]
  {\begin{mathparfig}[#1]{#2}{#3}\begin{bnfgrammar}}
  {\end{bnfgrammar}\end{mathparfig}}

% Judgement boxes should precede a mathpar

\newcommand{\judgbox}[2]{%
  \fbox{\ensuremath{#1}}%
  {\begin{tabular}[c]{l} #2 \end{tabular}}%
  \\[-1.5ex]
}

%
% Proof cases and other things in proofs.
% These macros assume you use an `itemize' or `enumerate' environment
%

%% Useing itemize

\newcommand{\proofcase}[2][Case]{\item \emph{#1 #2}.}
\newcommand{\proofcasemath}[2][Case]{\proofcase[#1]{\ensuremath{#2}}}

\newcommand{\proofcasederivation}[4][Case]{%
  \item %
    \parbox[t]{100ex}{%
      \emph{#1 } \\
      $~$\hspace*{5ex}
      \ensuremath{%
	\inferrule*[Right=#2]{#3}{#4}%
      }%
    }%
    \nopagebreak \\[0.2ex]
  }
\newcommand{\proofcaserewrite}[4][Case]{%
  \item %
    \parbox[t]{100ex}{%
      \emph{#1 } \\
      $~$\hspace*{5ex}
      \ensuremath{%
	{\inferrule*[fraction={{}{-}\to},Right=#2]{#3}{#4}}%
      }%
    }%
    \nopagebreak \\[0.2ex]
  }


\newcommand{\proofcasederivationdouble}[7][Case]{%
  \item
    \parbox[t]{100ex}{%
      \emph{#1 } \\
      $~$\hspace*{5ex}
      \begin{tabular}[C]{L}
	\inferrule*[Right=#2]{#3}{#4}%
	\\[1ex]
	\inferrule*[Right=#5]{#6}{#7}%
      \end{tabular}
    }%
    \nopagebreak \\[0.2ex]
  }

\newenvironment{proofcases}
   {\begin{itemize}}
   {\end{itemize}}

%% Case and Subcases

%% {proofcases}

\newcommand {\prooflabel@}[2]
  {\descriptionlabel {\proofcasestyle
    {\edef \@test {#2}\ifx \@test \empty
      \ifnum #1=1 Case\else
        \ifnum #1=2 Subcase\else
          Subsubcase\fi\fi
      \else #2\fi}}}
\newcommand {\proofcasestyle}[1]{\textbf{#1}}

\newlist{Proofcases}{description}{3}
\setlist[Proofcases]
   {before={\def \makelabel{\prooflabel@3}},
    style=sameline,leftmargin=1em}
\setlist[Proofcases,2]
   {before={\def \makelabel{\prooflabel@2}},
    style=sameline,leftmargin=1em}
\setlist[Proofcases,1]
   {before={\def \makelabel{\prooflabel@1}},
    style=sameline,leftmargin=1em}


\newcommand{\proofitem}[1][]
  {\ifempty{#1}{\item}{\item[\proofcasestyle{#1}]}}

\newcommand{\Proofcase}[2][]
  {\proofitem[#1] \emph{#2}.}
\newcommand{\Proofcasemath}[2][Case]{\proofcase[#1]{\ensuremath{#2}}}
\newcommand{\Proofcasederivation}[4][]{%
  \proofitem[#1]
    \indent \par\nopagebreak \vskip 1.2ex\nopagebreak
    \indent \hbox to 100ex {%
      \ensuremath{%
	\inferrule*[Right=#2]{#3}{#4}%
      }\hfil}%
    \nopagebreak \vskip 0.2ex
  }


\newcommand{\Proofcasederivationdouble}[7][]{%
  \proofitem[#1]
      \indent \par\nopagebreak \vskip .4ex\nopagebreak \indent
      \begin{tabular*}{100ex}[t]{.L.}
	\inferrule*[Right=#2]{#3}{#4}%
	\\[1ex]
	\inferrule*[Right=#5]{#6}{#7}%
      \end{tabular*}%
    \nopagebreak \vskip 0.2ex
  }

\newcommand{\Proofcaserewrite}[4][]{%
  \proofitem[#1] %
    \indent \par\nopagebreak \vskip 1.2ex\nopagebreak
    \indent \hbox to 100ex {%
      \ensuremath{%
	{\inferrule*[fraction={{}{-}\to},Right=#2]{#3}{#4}}%
      }%
    }%
    \nopagebreak \vskip 0.2ex
  }


%% Renew
\True%\False
{\renewenvironment{proofcases}
   {\begin{Proofcases}
    \let \proofcase  \Proofcase
    \let \proofcasemath \Proofcasemath
    \let \proofcasederivation \Proofcasederivation
    \let \proofcasederivationdouble  \Proofcasederivationdouble
     \let \proofcaserewrite \Proofcaserewrite}
   {\end{Proofcases}}
}{}

\newcommand{\Hand}{\text{\Pointinghand~~~~}}
