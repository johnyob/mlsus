\usepackage{amsmath}
\usepackage{amsthm}

%% Mathpartir

\usepackage{mathpartir}

\newcommand{\mathparinit}{
% spacing below and above mathpar blocks
\abovedisplayskip .5em
\belowdisplayskip .5em
}
\newcommand{\Rule}[1]{\hyperlink{#1}{\TirName {#1}}}
\renewcommand{\DefTirName}[1]{\hypertarget{#1}{\TirName {#1}}}

\newcommand \Rewrite[3][]
   {\inferrule*[fraction={==\Rightarrow},lab=#1]{#2}{#3}}
\newcommand \rewrite[3][]
   {\inferrule*[fraction={{}{-}\to},lab=#1]{#2}{#3}}

\newtheorem*{notation}{Notation}
\newtheorem{fact}{Fact}
\newtheorem{property}{Property}

\newenvironment{remark}
   {\paragraph{Remark}}
   {}

% This looks like a space hack, but it's not! The point
% is to remove a visually-ugly stacking of spacings coming
% from the figure and the math environment.
\newenvironment{mathparfig}[3][htb!]
   {\begin{figure}[#1]
       \abovedisplayskip 0em
       \belowdisplayskip 0em
       \def \LABEL{#2}%
       \def \CAPTION{#3}%
       \begin{mathpar}}
       {\end{mathpar}%
       \caption{\CAPTION}%
       \label{\LABEL}%
     \end{figure}}

\newenvironment{mathline}
   {\abovedisplayskip 0.1em
    \belowdisplayskip 0.1em
    \begin{mathpar}}
   {\end{mathpar}}

%% Arrays and tabular
\usepackage{array}

\newcolumntype{L}{>{${}}l<{{}$}}
\newcolumntype{R}{>{${}}r<{{}$}}
\newcolumntype{C}{>{${}}c<{{}$}}

\newcolumntype{.}{@{}}
\newcolumntype{+}{@{\qquad}}
\newcolumntype{;}{@{\;}}
\newcolumntype{,}{@{\,}}

\newcolumntype{~}{@{\extracolsep{\fill}}}
\newcolumntype{=}{@{\extracolsep{0em}}}
\newcolumntype{Z}{~c=}

\newcommand {\emath}[1]{\ensuremath{#1}}

\newcommand {\bnf@entryset}[3][]
  {\bnf@flushentry \gdef\@bnf@entry {&&#1}
   & #2 &\bnf@in & #3\bnf@flushentry}
\newcommand {\bnf@emptyentry}[2][]
  {\bnf@flushentry \gdef\@bnf@entry {&&#1}
   & #2&&\bnf@flushentry}
\newcommand {\bnf@entry}[3][]
  {\bnf@flushentry \gdef\@bnf@entry {&&#1}
   & #2&\ifempty{#2}{}{\ifempty{#3}{}{\bnf@is}}& #3\bnf@flushentry}
\def \bnf@empty{\gdef \@bnf@entry{}}\bnf@empty
\def \bnf@in {\in}
\def \bnf@is {::=}
\def \bnf@mid {\mid}
\def \bnf@flushentry{\@bnf@entry \bnf@empty}
\def \bnf@andcr{\bnf@flushentry \\&&\bnf@mid&}
\def \bnf@nextline #1{\bnf@andcr \ifthenelse {\equal{#1}{\bnf@mid}}{}{#1}}

\newenvironment{bnfgrammar}[1][]
  {\let \entry \bnf@entry
   \let \entryset \bnf@entryset
   \let \is \bnf@is
   \let \and \bnf@mid
   \let \andcr \bnf@andcr
   \let \And \bnf@andcr
   \let \nextline \bnf@nextline
   #1\relax
   \begin{tabular*}{\linewidth}{.C~R=;;R;;LL~r.}}
 {\end{tabular*}}

\newcommand{\leftalign}[2][.L.]
   {\begin{tabular}[#1]#2\end{tabular}}

\newcommand{\Defined}{\downarrow\mathclose{}}
\newcommand{\Undefined}{\uparrow\mathclose{}}

\newenvironment{bnffig}[3][htb!]
  {\begin{mathparfig}[#1]{#2}{#3}\begin{bnfgrammar}}
  {\end{bnfgrammar}\end{mathparfig}}

% Judgement boxes should precede a mathpar

\newcommand{\judgbox}[2]{%
  \fbox{\ensuremath{#1}}%
  {\begin{tabular}[c]{l} #2 \end{tabular}}%
  \\[-2ex]
}

%
% Proof cases and other things in proofs.
% These macros assume you use an `itemize' or `enumerate' environment
%

\newcommand{\proofcase}[2][Case]{\item \emph{#1 #2}. ~}
\newcommand{\proofcasemath}[2][Case]{\proofcase[#1]{\ensuremath{#2}}}
\newcommand{\proofcasederivation}[4][Case]{%
  \item %
    \parbox[t]{100ex}{%
      \emph{#1 } \\
      $~$\hspace*{5ex}
      \ensuremath{%
	\inferrule*[Right=#2]{#3}{#4}%
      }%
    }%
    \nopagebreak \\[0.2ex]
  }

\newcommand{\proofcasederivationdouble}[7][Case]{%
  \item
    \parbox[t]{100ex}{%
      \emph{#1 } \\
      $~$\hspace*{5ex}
      \begin{tabular}[C]{L}
	\inferrule*[Right=#2]{#3}{#4}%
	\\[1ex]
	\inferrule*[Right=#5]{#6}{#7}%
      \end{tabular}
    }%
    \nopagebreak \\[0.2ex]
  }

\newcommand{\Hand}{\text{\Pointinghand~~~~}}
