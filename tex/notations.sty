\RequirePackage{metavar}
\RequirePackage{boolean}
\RequirePackage{stmaryrd}

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand \kwd[1]{\mathsf{#1}}
\newcommand \mathpostfix[2][\kwd]{\mathrel{#1{#2}}\mathclose{}}
\newcommand \mathprefix [2][\kwd]{\mathopen{}\mathrel{#1{#2}}}
\newcommand \mathinfix [2][\kwd]{\mathrel{#1{#2}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Alistair

\newcommand{\Let}{\mathprefix{let}}
\newcommand{\In}{\mathinfix{in}}
\newcommand{\MLet}{\mathprefix{\textsl{let}}}
\newcommand{\MIn}{\mathinfix{\textsl{in}}}
\newcommand{\Match}{\mathprefix{match}}
\newcommand{\With}{\mathinfix{with}}
\newcommand{\Matches}{\mathinfix{matches}}

\newcommand{\shq}[2]{\any {#1}{#2}}

\let \c \relax
\defmetavar{\c}{C}
\newcommand{\cone}{\c_1}
\newcommand{\ctwo}{\c_2}
\newcommand{\ctrue}{\mathsf{true}}
\newcommand{\cfalse}{\mathsf{false}}
\newcommand{\cexists}[2]{\exists {#1}.\, #2}
\newcommand{\cfor}[2]{\forall {#1}.\, #2}
\newcommand{\call}[2]{\forall {#1}.\, #2}
\newcommand{\cand}{\wedge}
\newcommand{\cAnd}{\bigwedge}
\newcommand{\cunif}[2]{{#1} = {#2}}
\newcommand{\cinst}[2]{#1 \; #2}
\newcommand{\cleq}[2]{#1 \leq #2}
\newcommand{\cletin}[3]{\Let #1 = #2 \In #3}
\newcommand{\cabs}[2]{\lambda {#1}. \,{#2}}
\newcommand{\clam}[2]{\lambda {#1}. \,{#2}}
\newcommand{\cabsr}[3]{\cabs {{#1}\where{#2}} {#3}}
\newcommand{\capp}[2]{#1 \; #2}
\newcommand{\cmatch}[2]{\Match #1 \With #2}
\newcommand{\cmatchdots}[1]{\Match #1 \With \dots}
\newcommand{\clet}[4]{\cletin {#1}{\clam{#2}{#3}}{#4}}
\newcommand{\Clet}[4]{\Let #1\; #2 = #3 \In #4}
\newcommand{\cletr}[5]{\Clet{#1}{#2\;\where{#3}}{#4}{#5}}
\newcommand{\Csuspend}[4]{\cmatch {#1}{#3}{\clam {#2}{#4}}}
\newcommand{\csuspend}[4]{#1?#2 [#3]\to}
\newcommand{\cequiv}{\equiv}
\newcommand{\centails}{\vDash}
\newcommand{\Ground}{\mathcal {G}}
\newcommand{\Types}{\mathcal {T}}
\newcommand{\TyVars}{\mathcal{V}}
\newcommand{\Shapes}{\mathcal {S}}
\newcommand{\Shapesz}{\Shapes^\ast}
\newcommand{\cmatches}[4][=]{#2 \Matches #3 #1 #4}
\newcommand{\cwild}{\wild}
\newcommand{\csolve}{\longrightarrow}
\newcommand{\cnsolve}{\longarrownot\longrightarrow}
\newcommand{\unif}{\longrightarrow}
\newcommand{\Determines}{\mathinfix{determines}}
\newcommand{\cdetermines}[2]{#1 \Determines #2}
\newcommand{\cerase}[1]{\floor {#1}}

\defmetavar{\sub}{\vartheta}


\newcommand{\compose}{\circ}

\defmetavar{\cpat}{\rho}
\newcommand{\cpatprod}[2]{\Pi~{{#1}_{#2}}}
\newcommand{\cpatpoly}[1]{\tpoly {#1}}
\newcommand{\cpatwild}{\wild}
\newcommand{\cpatrcd}[1]{\wild \Tapp[#1]}
\defmetavar{\cs}{s}
\defmetavar{\ct}{t}
\defmetavar[s]{\cbr}{\chi}
\newcommand{\cbranch}[2]{#1 \to #2}

\newcommand{\cpapp}[4]{{#1} \where{{#2} \th {#3}} \; #4}
\defmetavar{\ren}{\rho}

\defmetavar{\up}{U}
\defmetavar[s]{\ueq}{\epsilon}
\defmetavar{\Up}{\mathcal{U}}


\newcommand{\mlam}[2]{\lambda {#1}. \,{#2}}
\newcommand{\mlet}[3]{\MLet #1 = #2 \MIn #3}

\newcommand{\cctx}{\mathscr{C}}
\newcommand \Cshape[3]{#1 \where {#2 \mathop{!} #3}}

\newcommand{\semenv}{\phi}
\newcommand{\semenvp}{\semenv'}

\newcommand{\semmetaenv}{\mathscr{M}}
\newcommand{\semmetav}{\mathscr{X}}

\newcommand{\deriv}{\mathscr{D}}
\newcommand{\derivp}{\deriv'}

\newcommand{\ctxindex}[2]{{#1}/{#2}}

\newcommand{\F}{\mathpostfix{F}}
\newcommand{\T}{\mathpostfix{t}}
\newcommand{\Fapp}{\mathop{}\mathrel{\F}}
\newcommand{\Tapp}[1][\T]{\mathrel{#1}\mathclose{}}
\newcommand{\shapp}[1][\sh]{\mathopen{}\mathrel{\angles{#1}}}
%\newcommand{\pshapp}[1][\sh]{\shapp[!#1]}
\newcommand{\pshapp}{\shapp}

\newcommand{\deshaped}[3][]
   {\angles{\ifempty{#1}{}{\any{#1}}{#2}}\ifempty{#3}{}{\;#3}}
\newcommand{\deshape}[1]{\mathprefix{deshaped}(#1)}

\renewcommand{\t}{\tau}
\newcommand{\tp}{\t'}
\newcommand{\tone}{\t_1}
\newcommand{\ttwo}{\t_2}
\newcommand{\ti}{\t_i}
\newcommand{\tj}{\t_j}
\defmetavar[s,ps]{\tva}{\alpha}
\defmetavar[s,ps]{\tvb}{\beta}
\defmetavar[s,ps]{\tvc}{\gamma}
%% Aliases for \tva
\newcommand{\tv}{\tva}
\newcommand{\tvp}{\tvap}
\newcommand{\tvs}{\tvas}
\newcommand{\tvps}{\tvaps}
\newcommand{\tvi}{\tvai}
\defmetavar{\tw}{\tvb}
\defmetavar{\gt}{\mathfrak{g}}
\defmetavar{\glam}{\mathfrak{G}}
\newcommand{\gabsr}[3][\glam]{{#1} [#2\;\where{#3}]}
\defmetavar{\gscm}{\mathfrak{s}}
\newcommand{\Powerset}[1]{\mathcal{P}(#1)}

\newcommand{\tarrow}{\to}
\newcommand{\tprod}{\mathbin\ast}
\newcommand{\tProd}[1]{\Pi\iton {#1}}
\newcommand{\tfor}[2]{\forall {#1}.\,{#2}}
\newcommand{\tpoly}[1]{\brackets {#1}}
\newcommand{\tapoly}[2]{\tpoly{#1}^{#2}}
\newcommand{\tunit}{1}
\newcommand{\tint}{\mathsf{int}}
\newcommand{\tbool}{\mathsf{bool}}
\newcommand{\fvs}[1]{\mathsf{fv}({#1})}

\newcommand{\tlist}{\mathpostfix{list}}
\newcommand{\trec}[2]{\mathprefix{rec}#1.#2}
\newcommand{\tsrecord}[1]{\braces {#1}}



\renewcommand {\th}{\vdash}
\newcommand {\mlexp}[3][\G]{#1 \th #2: #3}
\newcommand {\mltyp}[2][\G]{#1 \th #2}
\newcommand {\mlsub}[3][\G]{#1 \th #2 \le #3}
\newcommand {\iton}[1][n]{_{i=1}^{#1}}
\renewcommand{\@}{\;}

\newcommand{\econstr}[2]{#1 \@ #2}
\newcommand{\einst}[2][]{\angles {#2\ifempty{#1}{}{:#1}}}
\newcommand{\exinst}[3]{\angles {#1 : \exists {#2}. \, #3}}
\newcommand{\epoly}[2][]{\tpoly{#2\ifempty{#1}{}{:#1}}}
\newcommand{\expoly}[2]{\epoly {#1:#2}}
\newcommand{\eunit}{()}
\newcommand{\efun}[2]{\lambda #1. \, #2}
\newcommand{\eapp}[2]{#1 \; #2}
\newcommand{\eappp}[2]{\mathprefix{\eapp{#1}{#2}}}
\newcommand{\eApp}{\mathbin{@}}
\newcommand{\ePipe}{\mathbin{\triangleright}}
\newcommand{\elet}[3]{\Let #1 = #2 \In #3}
\newcommand{\ematch}[2]{\Match #1 \With #2}
\newcommand{\ecase}[3]{#1 \; #2 \Rightarrow #3}
\newcommand{\efield}[2]{#1.#2}
\newcommand{\exfield}[3]{#1.#3/#2}
%% Could be factored as
\newcommand{\eproj}[3][]{#2.#3\ifempty{#1}{}{/#1}}
\newcommand{\erecord}[1]{\braces{#1}}
\defmetavar{\el}{l}
\newcommand{\elcast}[2]{\parens {{#1} \mathop{\triangleleft} {#2}}}
\defmetavar{\elab}{\ell}
\newcommand{\eannot}[3]{\parens {#1 : \exi #2 #3}}
\newcommand{\etuple}[1]{\parens{#1}}

\newcommand {\parens}[1]{(#1)}
\newcommand {\braces}[1]{\{#1\}}
\newcommand {\brackets}[1]{[#1]}
\newcommand {\bbrackets}[1]{\llbracket #1\rrbracket}
\newcommand {\pparens}[1]{\llparenthesis #1 \rrparenthesis}
\newcommand {\ceils}[1]{\lceil #1\rceil}
\newcommand {\floors}[1]{\lfloor #1\rfloor}
\newcommand {\angles}[1]{\langle #1\rangle}
\newcommand {\highdelim}[2]{\left#1{#2\right}}
\newcommand {\Parens}[1]{\highdelim\parens {#1}}
\newcommand {\Braces}[1]{\highdelim\braces {#1}}
\newcommand {\Angles}[1]{\highdelim\angles {#1}}
\newcommand {\Brackets}[1]{\highdelim\brackets {#1}}
\newcommand {\Bbrackets}[1]{\highdelim\bbrackets {#1}}
\newcommand {\floor}[1]{\lfloor #1 \rfloor}
\newcommand {\set}[1]{\braces{#1}}
\newcommand {\eset}{\emptyset}
\newcommand {\where}[1]{\brackets {#1}}
\newcommand {\Where}[1]{\Brackets {#1}}
\newcommand {\is}{:=}

\newcommand{\csem}[1]{\bbrackets {#1}}
\newcommand{\cinfer}[2]{\csem {#1 : #2}}
\newcommand{\cinferlab}[3]{\csem {#1 : #2 \to #3}}
\newcommand{\cinferlabuni}[2]{\csem {#1 \uni #2}}
\newcommand{\cinferassn}[3]{\csem {#1 = #2 : #3}}

%% \newcommand{\TODO}{\textcolor{red}{TODO}}
\newcommand{\disjoint}{\mathop{\#}}
\newcommand{\shape}[1]{\mathprefix{shape}(#1)}
\newcommand{\decomp}[1]{\mathprefix{decomp}(#1)}
\newcommand{\cyclic}[1]{\mathprefix{cyclic}(#1)}
\newcommand{\trivial}[1]{\mathprefix{trivial}(#1)}
\newcommand{\dom}{\mathprefix{dom}}
\newcommand{\rng}{\mathprefix{rng}}

% Common metas
\defmetavar{\e}{e}
\newcommand{\eone}{\ea}
\newcommand{\etwo}{\eb}
%% \newcommand{\ei}{\e_i}
\newcommand{\en}{\e_n}

\defmetavar{\C}{\mathscr{C}}

\newcommand{\Sh}{\zeta}
\newcommand{\Shp}{\Sh'}
\newcommand{\sh}{\varsigma}
\newcommand{\shp}{\sh'}

%% Type schemes
\defmetavar {\ts} {\sigma}
\newcommand{\sigmaone}{\ts_1}
\newcommand{\sigmatwo}{\ts_2}
\newcommand{\sigmai}{\ts_i}
\newcommand{\sigman}{\ts_n}

\newcommand{\hf}{f}

\newcommand{\labone}{l_1}
\newcommand{\labtwo}{l_2}
\newcommand{\labi}{l_i}
\newcommand{\labn}{l_n}

\newcommand{\evari}{x_i}

\newcommand{\K}{\mathsf{K}}
\newcommand{\Ki}{\K_i}

\newcommand {\D} {\Delta}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DR


%% Types
%% \defmetavar {\t} {\tau}
%% We could instead use \ty
%% \defmetavar {\ty} {\tau}

%% Expression variables
\defmetavar {\x} {x}
%% \defmetavar {\Ts} {\chi}
\defmetavar {\ty} {\tau}\newcommand{\typs}{{\bar\ty'}}
\defmetavar {\E} {E}
\defmetavar {\Lab} {\mathscr{L}}
\newcommand {\tss} {\bar\ts}
\newcommand {\tys} {\bar\ty}
%% Annotation variables
\defmetavar {\av} {\varepsilon}
\defmetavar {\G} {\Gamma}
\defmetavar {\enil} {\cdot}


\newcommand{\all}[2]{\forall #1.\,#2}
\newcommand{\exi}[2]{\exists #1.\,#2}
\newcommand{\any}[2]{\nu #1.\,#2}
\newcommand{\uni}{\mathop{!}}

\newcommand{\eqdef}{\mathrel{\triangleq}}
\newcommand \uad [1][1ex]{\hskip #1}
\newcommand \wide[2][\;]{#1 #2 #1}
\newcommand \Wide[2][\uad]{#1 #2 #1}
\newcommand \ftv [1]{\textsf{ftv}(#1)}
\newcommand \cpoly [2]{#1\;\angles{#2}}
\newcommand \ehole {\square}
\newcommand \emagic[1]{\set{#1}}
\newcommand \wild {{\_}}
\newcommand \eshape[3]{#1 \where {#2 \mathop{\triangleright} #3}}
\newcommand \Eshape[3]{#1 \where {#2 \mathop{\triangleleft} #3}}
\newcommand \Lshape[3]{#1 \where {#2 \mathop{!} #3}}
\newcommand \ecast [3]{#1  : #2 \bowtie #3}
\newcommand \sbot {\bot}
\newcommand \tshape [1]{\mathprefix {shape}{#1}}
\newcommand \labenv {\Omega}

\defmetavar{\tc}{\mathprefix{c}}
